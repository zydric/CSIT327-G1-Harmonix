{% extends 'base.html' %}
{% load static %}

{% block title %}Sent Invitations - Harmonix{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">Sent Invitations</h1>
        <p class="text-gray-600">Track the invitations you've sent to musicians.</p>
    </div>

    <!-- Search Bar -->
    <div class="mb-8">
        <div class="relative">
            <svg class="absolute left-4 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
            <input type="text" 
                   id="searchSentInvites"
                   placeholder="Search by musician name, listing title, or status..."
                   class="w-full pl-12 pr-4 py-4 text-base border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#4F2FC0] focus:border-transparent transition-all">
        </div>
    </div>

    <div class="space-y-6">
        {% for invitation in invitations %}
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                <div class="p-6">
                    <div class="flex flex-col md:flex-row gap-6">
                        
                        <div class="w-full md:w-1/3 flex-shrink-0">
                            <div class="flex items-center space-x-4">
                                <div class="w-12 h-12 rounded-full flex items-center justify-center text-white font-semibold text-lg shrink-0" 
                                     style="background-color: {{ invitation.musician.get_avatar_color }};">
                                    {{ invitation.musician.get_avatar_initial }}
                                </div>
                                <div>
                                    <h3 class="text-lg font-bold text-gray-900 leading-tight">
                                        {{ invitation.musician.get_full_name|default:invitation.musician.username }}
                                    </h3>
                                    <p class="text-sm text-[#4F2FC0] font-medium">@{{ invitation.musician.username }}</p>
                                </div>
                            </div>

                            <div class="mt-6 space-y-3">
                                <div class="flex items-center text-gray-600 text-sm">
                                    <svg class="w-4 h-4 mr-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                                    </svg>
                                    {{ invitation.musician.location|default:"Location hidden" }}
                                </div>
                                <div class="flex items-center text-gray-600 text-sm">
                                    <svg class="w-4 h-4 mr-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"/>
                                    </svg>
                                    {% if invitation.musician.instruments_list %}
                                        {{ invitation.musician.instruments_list|join:", " }}
                                    {% else %}
                                        Musician
                                    {% endif %}
                                </div>
                                <div class="flex items-center text-gray-500 text-sm">
                                    <svg class="w-4 h-4 mr-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                    </svg>
                                    Sent {{ invitation.created_at|date:"M d, Y" }}
                                </div>
                            </div>
                        </div>

                        <div class="flex-1 md:border-l md:border-gray-100 md:pl-6 relative flex flex-col justify-between">
                            <div>
                                <div class="absolute top-0 right-0">
                                    {% if invitation.status == 'accepted' %}
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 border border-green-200">
                                            <svg class="mr-1.5 h-2 w-2 text-green-400" fill="currentColor" viewBox="0 0 8 8">
                                                <circle cx="4" cy="4" r="3" />
                                            </svg>
                                            Accepted
                                        </span>
                                    {% elif invitation.status == 'pending' %}
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800 border border-yellow-200">
                                            <svg class="mr-1.5 h-2 w-2 text-yellow-400" fill="currentColor" viewBox="0 0 8 8">
                                                <circle cx="4" cy="4" r="3" />
                                            </svg>
                                            Pending
                                        </span>
                                    {% else %}
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 border border-gray-200">
                                            {{ invitation.status|title }}
                                        </span>
                                    {% endif %}
                                </div>

                                <div class="mt-2 pr-16"> 
                                    <h4 class="text-sm font-semibold text-gray-900 mb-2">Your Message:</h4>
                                    <div class="bg-gray-50 rounded-lg p-4 text-gray-700 italic text-sm border border-gray-100 leading-relaxed">
                                        "{{ invitation.message }}"
                                    </div>
                                </div>
                            </div>

                            <div class="mt-4 pt-4 border-t border-gray-100 flex justify-between items-center">
                                <span class="text-xs text-gray-500">
                                    Invitation for listing: 
                                    <a href="{% url 'listings:detail' pk=invitation.listing.pk %}" class="font-medium text-[#4F2FC0] hover:underline">{{ invitation.listing.title }}</a>
                                </span>
                                
                                {% if invitation.status == 'pending' %}
                                    <button onclick="confirmWithdraw({{ invitation.id }}, '{{ invitation.listing.title|escapejs }}')" class="text-sm text-red-600 hover:text-red-800 font-medium transition-colors">
                                        Withdraw Invitation
                                    </button>
                                {% elif invitation.status == 'accepted' %}
                                    <button class="text-sm text-[#4F2FC0] hover:text-purple-800 font-medium">
                                        Send Message
                                    </button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                {% if invitation.status == 'accepted' %}
                    <div class="bg-green-50 px-6 py-4 border-t border-green-100 flex items-start space-x-3">
                        <svg class="w-5 h-5 text-green-600 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                        <div>
                            <h4 class="text-sm font-bold text-green-800">Invitation Accepted!</h4>
                            <p class="text-sm text-green-700 mt-1">{{ invitation.musician.first_name|default:invitation.musician.username }} has accepted. You can now view their contact details.</p>
                        </div>
                    </div>
                {% elif invitation.status == 'pending' %}
                    <div class="bg-yellow-50 px-6 py-4 border-t border-yellow-100 flex items-start space-x-3">
                        <svg class="w-5 h-5 text-yellow-600 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <div>
                            <h4 class="text-sm font-bold text-yellow-800">Awaiting Response</h4>
                            <p class="text-sm text-yellow-700 mt-1">The musician hasn't responded yet. They'll be notified of your invitation.</p>
                        </div>
                    </div>
                {% endif %}
            </div>
        {% empty %}
            <div class="text-center py-12 bg-gray-50 rounded-xl border-2 border-dashed border-gray-200">
                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                </svg>
                <h3 class="mt-2 text-sm font-medium text-gray-900">No invitations sent</h3>
                <p class="mt-1 text-sm text-gray-500">Get started by finding musicians and inviting them to your listings.</p>
                <div class="mt-6">
                    <a href="{% url 'invitations:band_admin_invite' %}" class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-[#4F2FC0] hover:bg-[#4328a3]">
                        Browse Musicians
                    </a>
                </div>
            </div>
        {% endfor %}
    </div>
</div>

<form id="withdrawForm" method="POST" style="display: none;">
    {% csrf_token %}
</form>

<script>
function confirmWithdraw(invitationId, listingTitle) {
    showConfirmModal({
        title: 'Withdraw Invitation',
        message: `Are you sure you want to withdraw your invitation for "${listingTitle}"?`,
        confirmText: 'Withdraw',
        type: 'danger',
        onConfirm: function() {
            const form = document.getElementById('withdrawForm');
            form.action = `/invitations/${invitationId}/withdraw/`; 
            form.submit();
        }
    });
}

// Real-time search for sent invitations
document.getElementById('searchSentInvites')?.addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();
    const invitations = document.querySelectorAll('.space-y-6 > div');
    
    invitations.forEach(invitation => {
        const text = invitation.textContent.toLowerCase();
        if (searchTerm === '' || text.includes(searchTerm)) {
            invitation.style.display = 'block';
        } else {
            invitation.style.display = 'none';
        }
    });
});
</script>

{% endblock %}